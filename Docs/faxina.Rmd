---
title: "Faxina"
author: "Trevelim, LP; Panosso, AR"
date: "2025-04-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE)
```

### Objetivo

Este script tem como objetivo realizar a etapa de faxina de dados, ou seja, aplicar transformações, padronizações e correções necessárias para garantir a qualidade dos dados utilizados nas análises. Aqui são tratados problemas como valores ausentes, formatação inconsistente, e possíveis outliers.

#### Instalação 

```{r}
# install.packages("devtools")
# devtools::install_github("arpanosso/fco2r",force = TRUE)
```

#### Problemas na instalação
```{r}
# Sys.getenv("GITHUB_PAT")
# Sys.unsetenv("GITHUB_PAT")
# Sys.getenv("GITHUB_PAT")
```

#### Carregando Pacotes
```{r}
library(fco2r)
library(tidyverse)
library(geobr)
library(ggpubr)
theme_set(theme_bw())
```

#### Faxina - Dados de Emissão de CO2 do solo
```{r}
data_fco2 <- data_fco2 |> 
  janitor::clean_names() |> 
  mutate(
    municipio = case_when(
      municipio == "Selv?ra" ~ "Selvíria",
      municipio == "Selv?ria" ~ "Selvíria",
      municipio == "Prad?polis" ~ "Pradópolis",
      TRUE ~ municipio
    ))
glimpse(data_fco2)
```

#### Faxina - XCO2 - NASA-OCO2
```{r}
oco2_br <- oco2_br %>% 
  janitor::clean_names() |> 
   mutate(
           xco2 = xco2_moles_mole_1*1e06,
           data = ymd_hms(time_yyyymmddhhmmss),
           year = year(data),
           month = month(data),
           day = day(data),
           w_day = wday(data),
           sif = (fluorescence_radiance_757nm_idp_ph_sec_1_m_2_sr_1_um_1*2.6250912*10^(-19)  + 1.5*fluorescence_radiance_771nm_idp_ph_sec_1_m_2_sr_1_um_1* 2.57743*10^(-19))/2,
           sif = ifelse(sif > 0, sif, median(sif))
           )
glimpse(oco2_br)
```

```{r}
brasil_geobr <- read_country(showProgress = FALSE)
brasil_geobr |>  
  ggplot() +
  geom_sf(fill="white", color="black",
          size=.15, show.legend = FALSE) +
  geom_point(data=oco2_br %>%  
                        sample_n(10000) ,
             aes(x=longitude,y=latitude),
             shape=1,
             col="red",
             alpha=01)+
  labs(x="Longitude",y="Latitude")
```
Existe uma tendência de aumento monotônica mundial da concentração de CO~2~ na atmosfera, assim, ela deve ser retirada para podermos observar as tendências regionais. Observe que o sinal na variável X~CO2~ não apresenta a tendência descrita.

```{r}
oco2_br   |>   
  ggplot(aes(x=data,y=xco2)) +
  geom_point(shape=21,color="black",fill="gray") +
  geom_smooth(method = "lm") +
  stat_regline_equation(aes(
  label =  paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~~")))
```
Análise de regressão linear simples para caracterização da tendência.


```{r}
mod_trend_xco2 <- lm(xco2 ~ data, 
          data = oco2_br |> 
            mutate( data = data - min(data)) 
          )
summary.lm(mod_trend_xco2)
```
```{r}
a_co2 <- mod_trend_xco2$coefficients[[1]]
b_co2 <- mod_trend_xco2$coefficients[[2]]
oco2_br <- oco2_br |>
  mutate(
    data_modif = data -min(data),
    xco2_est = a_co2+b_co2*data_modif,
    delta = xco2_est-xco2,
    xco2_detrend = as.numeric((a_co2-delta) - (mean(xco2) - a_co2))
  )
```

Plot dos dados sem a tendência, variável `xco2_detrend`.

```{r}
oco2_br   |>   
  ggplot(aes(x=data,y=xco2_detrend)) +
  geom_point(shape=21,color="black",fill="gray") +
  geom_smooth(method = "lm") +
  stat_regline_equation(aes(
  label =  paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~~")))
```

#### Unindo os bancos de dados


```{r}
data_set <- left_join(data_fco2  |>  
            mutate(year = year(data),
                   month = month(data)
                   ), 
          oco2_br  |>  
            select(data,month,year,longitude,latitude,xco2,xco2_detrend,sif,fluorescence_radiance_757nm_idp_ph_sec_1_m_2_sr_1_um_1,fluorescence_radiance_771nm_idp_ph_sec_1_m_2_sr_1_um_1), by = c("year","month") )  |>  
  mutate(dist = sqrt((longitude-(-51.423519))^2+(latitude-(-20.362911))^2)) |> 
  filter(dist <= .16, fco2 <= 30 ) |> 
  select(-fluorescence_radiance_757nm_idp_ph_sec_1_m_2_sr_1_um_1, -fluorescence_radiance_771nm_idp_ph_sec_1_m_2_sr_1_um_1, -dist)
```

